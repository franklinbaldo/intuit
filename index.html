<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline';" />
    <title>Intuit - HTML Renderer</title>
    <meta name="description" content="A minimalist HTML renderer and visual testing tool for developers, designers, and AI agents" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
      rel="stylesheet"
    />
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const htmlData = urlParams.get("data");
        const b64Data = urlParams.get("b64");
        const gistId = urlParams.get("gist"); // New: Get gist parameter
        const iframe = document.getElementById("iframe").contentWindow.document;
        const htmlEditor = document.getElementById("htmlEditor");
        const errorMessage = document.getElementById("errorMessage");

        function showError(message) {
          errorMessage.textContent = message;
          errorMessage.classList.remove("hidden");
        }

        function hideError() {
          errorMessage.textContent = "";
          if (!errorMessage.classList.contains("hidden")) {
            errorMessage.classList.add("hidden");
          }
        }

        if (htmlData) {
          renderHTML(htmlData);
          htmlEditor.value = htmlData; // Populate editor with loaded HTML
        } else if (b64Data) {
          try {
            const decodedHtml = atob(b64Data);
            renderHTML(decodedHtml);
            htmlEditor.value = decodedHtml; // Populate editor with loaded HTML
          } catch (error) {
            console.error("Error decoding Base64 data: ", error);
          }
        } else if (gistId) {
          // New: Check for gistId
          hideError();
          console.log("Fetching Gist:", gistId);
          fetch(`https://api.github.com/gists/${gistId}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error(`GitHub API error: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              let htmlFileUrl = null;
              for (const file of Object.values(data.files)) {
                if (file.filename.endsWith(".html")) {
                  htmlFileUrl = file.raw_url;
                  break;
                }
              }

              if (htmlFileUrl) {
                return fetch(htmlFileUrl);
              } else {
                console.error("No HTML file found in Gist");
                throw new Error("No HTML file found in Gist"); // Stop promise chain
              }
            })
            .then((response) => {
              if (!response.ok) {
                // This 'response' is from fetching the raw_url
                throw new Error(
                  `Error fetching Gist raw content: ${response.status}`,
                );
              }
              return response.text();
            })
            .then((htmlText) => {
              hideError();
              renderHTML(htmlText);
              htmlEditor.value = htmlText; // Populate editor with loaded HTML
            })
            .catch((error) => {
              console.error("Error fetching Gist content:", error);
              showError("Failed to load Gist content.");
            });
        } else {
          const editorContent = htmlEditor.value;
          if (editorContent) {
            renderHTML(editorContent);
          }
        }

        const renderButton = document.getElementById("renderButton");
        const copyLinkButton = document.getElementById("copyLinkButton");
        const clearEditorButton = document.getElementById("clearEditorButton");
        const updateUrlButton = document.getElementById("updateUrlButton");
        const sandboxToggle = document.getElementById("sandboxToggle"); // New toggle
        const themeToggle = document.getElementById("themeToggle"); // Dark/light theme toggle
        const iframeElement = document.getElementById("iframe"); // Reference to the iframe element itself

        // Initialize theme based on localStorage
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
          document.documentElement.classList.add("dark");
          themeToggle.checked = true;
        }

        renderButton.addEventListener("click", () => {
          const htmlContent = htmlEditor.value;
          renderHTML(htmlContent);
        });

        copyLinkButton.addEventListener("click", () => {
          const htmlContent = htmlEditor.value;
          const encodedHtml = encodeURIComponent(htmlContent);
          const baseUrl = window.location.origin + window.location.pathname;
          const shareableLink = `${baseUrl}?data=${encodedHtml}`;

          navigator.clipboard
            .writeText(shareableLink)
            .then(() => {
              const originalButtonText = copyLinkButton.textContent;
              copyLinkButton.textContent = "Copied!";
              setTimeout(() => {
                copyLinkButton.textContent = originalButtonText;
              }, 2000); // Revert after 2 seconds
            })
            .catch((err) => {
              console.error("Failed to copy link: ", err);
              // You could also alert the user here if something goes wrong
            });
        });

        clearEditorButton.addEventListener("click", () => {
          // New event listener
          htmlEditor.value = ""; // Clear the editor
          renderHTML(""); // Clear the iframe
        });

        updateUrlButton.addEventListener("click", () => {
          const htmlContent = htmlEditor.value;
          const encodedHtml = encodeURIComponent(htmlContent);
          const baseUrl = window.location.origin + window.location.pathname;
          const newUrl = `${baseUrl}?data=${encodedHtml}`;
          history.replaceState(null, "", newUrl);
        });

        sandboxToggle.addEventListener("change", function () {
          if (sandboxToggle.checked) {
            iframeElement.sandbox =
              "allow-scripts allow-same-origin allow-popups allow-forms";
          } else {
            iframeElement.sandbox = "";
          }
          // Re-render the current content with the new sandbox settings
          const currentHtml = htmlEditor.value;
          renderHTML(currentHtml);
        });

        themeToggle.addEventListener("change", function () {
          if (themeToggle.checked) {
            document.documentElement.classList.add("dark");
            localStorage.setItem("theme", "dark");
          } else {
            document.documentElement.classList.remove("dark");
            localStorage.setItem("theme", "light");
          }
        });

        function renderHTML(html) {
          iframe.open();
          iframe.write(html);
          iframe.close();
        }
      });

      function htmz(frame) {
        setTimeout(() => {
          const hash = frame.contentWindow.location.hash;
          if (hash) {
            const element = frame.contentDocument.querySelector(hash);
            if (element) {
              element.replaceWith(...frame.contentDocument.body.childNodes);
            }
          }
        }, 0);
      }
    </script>
  </head>
  <body
    class="font-sans antialiased bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 dark:from-gray-900 dark:to-gray-800 dark:text-gray-100 min-h-screen"
  >
    <div class="container mx-auto p-4 sm:p-8 max-w-7xl">
      <!-- Header Section -->
      <header class="mb-8 text-center">
        <h1 class="text-5xl font-bold mb-2 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
          Intuit
        </h1>
        <p class="text-gray-600 dark:text-gray-400 text-lg">
          A minimalist HTML renderer & visual testing tool
        </p>
      </header>

      <!-- Error Message -->
      <div
        id="errorMessage"
        class="hidden bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg mb-6 shadow-sm"
      ></div>

      <!-- Main Content Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
        <!-- Editor Section -->
        <div class="mb-6">
          <label for="htmlEditor" class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">
            HTML Editor
          </label>
          <textarea
            id="htmlEditor"
            class="w-full h-64 border-2 border-gray-300 dark:border-gray-600 rounded-lg p-4 font-mono text-sm bg-gray-50 dark:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 transition-all resize-none"
            placeholder="Type or paste your HTML here..."
          ></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3 mb-6">
          <button
            id="renderButton"
            class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105"
          >
            Render
          </button>
          <button
            id="copyLinkButton"
            class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105"
          >
            Copy Link
          </button>
          <button
            id="updateUrlButton"
            class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105"
          >
            Update URL
          </button>
          <button
            id="clearEditorButton"
            class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105"
          >
            Clear
          </button>
        </div>

        <!-- Settings Toggles -->
        <div class="flex flex-wrap gap-6 mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
          <label class="flex items-center cursor-pointer group">
            <input type="checkbox" id="sandboxToggle" class="mr-3 w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" />
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
              Allow Scripts
            </span>
          </label>
          <label class="flex items-center cursor-pointer group">
            <input type="checkbox" id="themeToggle" class="mr-3 w-4 h-4 text-purple-600 rounded focus:ring-2 focus:ring-purple-500" />
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors">
              Dark Mode
            </span>
          </label>
        </div>

        <!-- Preview Section -->
        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">
            Preview
          </label>
          <iframe
            id="iframe"
            name="htmz"
            class="w-full h-96 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white shadow-inner"
            onload="htmz(this)"
            sandbox=""
          ></iframe>
        </div>
      </div>

      <!-- Footer -->
      <footer class="text-center text-sm text-gray-600 dark:text-gray-400 mt-8">
        <p>
          Made with ❤️ for developers, designers, and AI agents |
          <a href="https://github.com/franklinbaldo/intuit" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">
            View on GitHub
          </a>
        </p>
      </footer>
    </div>
  </body>
</html>
